<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Категории товаров</title>
    <style>
      .chat-container {
        width: 600px;
        margin: 20px auto;
        border: 1px solid #ccc;
        padding: 10px;
      }
      #messages {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #eee;
        margin-bottom: 10px;
        padding: 10px;
      }
      .message {
        margin: 5px;
        padding: 8px;
        border-radius: 5px;
        max-width: 80%;
      }
      .received {
        background: #e3f2fd;
        margin-right: auto;
      }
      .sent {
        background: #c8e6c9;
        margin-left: auto;
      }
      .status {
        text-align: center;
        color: #666;
        font-size: 0.9em;
      }
      .input-area {
        display: flex;
        gap: 10px;
      }
      input {
        flex: 1;
        padding: 8px;
      }
      button {
        padding: 8px 20px;
      }
    </style>
  </head>
  <body>
    <h1>Товары по категориям</h1>
    <div id="categories"></div>
    <div class="chat-container">
      <div id="messages"></div>
      <div class="input-area">
        <input
          type="text"
          id="messageInput"
          placeholder="Type your message..."
        />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3000/";
      const query = `
            query {
                products {
                    id
                    name
                    description
                    cost
                    category
                }
            }
        `;

      fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ query }),
      })
        .then((response) => response.json())
        .then((data) => {
          const products = data.data.products;
          const categories = {};

          products.forEach((item) => {
            const itemCategories = item.category
              ? item.category.split(",").map((cat) => cat.trim())
              : ["Без категории"];

            itemCategories.forEach((category) => {
              if (!categories[category]) {
                categories[category] = [];
              }
              categories[category].push(item);
            });
          });

          const categoriesContainer = document.getElementById("categories");
          Object.keys(categories).forEach((category) => {
            const categoryDiv = document.createElement("div");
            categoryDiv.classList.add("category");
            categoryDiv.innerHTML = `<h2>${category}</h2>`;

            categories[category].forEach((product) => {
              const productDiv = document.createElement("div");
              productDiv.classList.add("product");
              const name = product.name ? product.name : "Название отсутствует";
              const description = product.description
                ? product.description
                : "Описание отсутствует";
              const cost =
                product.cost !== undefined
                  ? `${product.cost} руб.`
                  : "Цена отсутствует";
              productDiv.innerHTML = `<strong>${name}</strong>: ${description} - ${cost}`;
              categoryDiv.appendChild(productDiv);
            });

            categoriesContainer.appendChild(categoryDiv);
          });
        })
        .catch((error) => console.error("Ошибка:", error));

      const ws = new WebSocket("ws://localhost:8080/?role=client");
      const messages = document.getElementById("messages");
      const input = document.getElementById("messageInput");

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "message") {
          appendMessage(data.content, "received");
        } else if (data.type === "status") {
          appendStatus(
            data.connected ? "Connected to support" : "Disconnected"
          );
        }
      };

      function sendMessage() {
        const message = input.value;
        if (message.trim()) {
          ws.send(JSON.stringify({ content: message }));
          appendMessage(message, "sent");
          input.value = "";
        }
      }

      function appendMessage(text, type) {
        const div = document.createElement("div");
        div.className = `message ${type}`;
        div.textContent = text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }

      function appendStatus(text) {
        const div = document.createElement("div");
        div.className = "status";
        div.textContent = text;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
      }
    </script>
  </body>
</html>

<!--

<!DOCTYPE html>
<html>
<head>
  <title>Client Chat</title>
  <style>
    /* Стили аналогичны админскому интерфейсу */
  </style>
</head>
<body>
 

  <script>
    const ws = new WebSocket('ws://localhost:8080/?role=client');
    const messages = document.getElementById('messages');
    const input = document.getElementById('messageInput');

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'message') {
        appendMessage(data.content, 'received');
      } else if (data.type === 'status') {
        appendStatus(data.connected ? 'Connected to support' : 'Disconnected');
      }
    };

    function sendMessage() {
      const message = input.value;
      if (message.trim()) {
        ws.send(JSON.stringify({ content: message }));
        appendMessage(message, 'sent');
        input.value = '';
      }
    }

    function appendMessage(text, type) {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function appendStatus(text) {
      const div = document.createElement('div');
      div.className = 'status';
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }
  </script>
</body>
</html>-->
